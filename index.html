<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Scoreboard Admin</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #050816;
            color: #fff;
            margin: 0;
            padding: 20px;
        }

        h1,
        h2 {
            margin-top: 0;
        }

        .card {
            max-width: 1040px;
            margin: 0 auto 16px;
            padding: 16px 20px;
            background: #0b1120;
            border-radius: 12px;
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.6);
        }

        .hidden {
            display: none;
        }

        input,
        button {
            font-size: 14px;
            border-radius: 6px;
            border: none;
            outline: none;
            padding: 8px 10px;
        }

        input {
            background: #111827;
            color: #e5e7eb;
        }

        button {
            background: #3b82f6;
            color: #fff;
            cursor: pointer;
            font-weight: 600;
        }

        button:hover {
            opacity: 0.92;
        }

        .login-form,
        .team-form {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: flex-end;
        }

        .row>div {
            flex: 1;
            min-width: 200px;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 14px;
            margin-bottom: 10px;
        }

        .left-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .match-line {
            font-size: 14px;
        }

        .match-line span {
            font-weight: 600;
            color: #bfdbfe;
        }

        .right-controls {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 6px;
        }

        .badge {
            padding: 4px 10px;
            background: #1d4ed8;
            border-radius: 999px;
            font-size: 11px;
        }

        .match-controls {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .match-name-input {
            width: 190px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 13px;
        }

        th,
        td {
            padding: 6px 4px;
            border-bottom: 1px solid #1f2937;
            vertical-align: middle;
        }

        th {
            text-align: left;
            color: #9ca3af;
        }

        img.logo {
            width: 40px;
            height: 40px;
            object-fit: contain;
            border-radius: 8px;
            background: #020617;
        }

        .actions button {
            margin-right: 4px;
            margin-bottom: 4px;
            font-size: 11px;
            padding: 4px 6px;
        }

        #teamMsg,
        #loginError {
            font-size: 12px;
            min-height: 16px;
        }

        #loginError {
            color: #fca5a5;
        }

        #teamMsg {
            color: #a5b4fc;
        }

        /* alive bars in admin table */
        .alive-cell-table {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .alive-bars {
            display: flex;
            gap: 2px;
        }

        .alive-bar {
            width: 8px;
            height: 14px;
            border-radius: 3px;
            background: #1f2937;
            border: 1px solid rgba(15, 23, 42, 0.9);
        }

        .alive-bar.alive {
            background: #22c55e;
            box-shadow: 0 0 4px rgba(34, 197, 94, 0.7);
        }

        .alive-bar.dead {
            background: #ef4444;
            box-shadow: 0 0 3px rgba(239, 68, 68, 0.6);
        }

        .kills-input,
        .alive-input {
            width: 60px;
        }

        .alive-input {
            width: 40px;
        }

        .pill {
            padding: 3px 8px;
            border-radius: 999px;
            background: #111827;
            font-size: 11px;
            color: #9ca3af;
        }
    </style>
</head>

<body>
    <!-- LOGIN CARD -->
    <div class="card" id="loginCard">
        <h1>Scoreboard Admin Login</h1>
        <form class="login-form" id="loginForm">
            <input type="email" id="email" placeholder="Admin email" required />
            <input type="password" id="password" placeholder="Password" required />
            <button type="submit">Login</button>
            <div id="loginError"></div>
        </form>
    </div>

    <!-- ADMIN PANEL -->
    <div class="card hidden" id="adminCard">
        <div class="top-bar">
            <div class="left-info">
                <h1>Scoreboard Control Panel</h1>
                <div class="match-line">
                    Match: <span id="matchNumberDisplay">1</span>
                    <span id="matchNameDisplay" style="margin-left:6px; opacity:0.8;"></span>
                </div>
                <div class="pill">Sorted by slot number</div>
            </div>

            <div class="right-controls">
                <span class="badge" id="userEmail"></span>
                <div class="match-controls">
                    <input type="text" id="matchNameInput" class="match-name-input"
                        placeholder="Match name (Erangel FPP)" />
                    <button id="saveMatchNameBtn" style="background:#22c55e;">Save Name</button>
                </div>
                <div class="match-controls">
                    <button id="nextMatchBtn" style="background:#f97316;">Next Match (Save + Add)</button>
                    <button id="hardResetBtn" style="background:#ef4444;">Hard Reset</button>
                </div>
                <button id="logoutBtn" style="background:#6b7280; margin-top:4px;">Logout</button>
            </div>
        </div>

        <h2>Add / Edit Team</h2>
        <form class="team-form" id="teamForm">
            <div class="row">
                <div>
                    <label>Team Name</label><br />
                    <input type="text" id="teamName" required />
                </div>
                <div>
                    <label>Slot #</label><br />
                    <input type="number" id="teamSlot" required />
                </div>
                <div>
                    <label>Team Logo (optional)</label><br />
                    <input type="file" id="teamLogo" accept="image/*" />
                </div>
            </div>
            <input type="hidden" id="editingId" />
            <button type="submit" id="saveBtn">Add / Update Team</button>
            <div id="teamMsg"></div>
        </form>

        <h2 style="margin-top:18px;">Live Teams (by Slot)</h2>
        <table>
            <thead>
                <tr>
                    <th>Slot</th>
                    <th>Logo</th>
                    <th>Name</th>
                    <th>Kills</th>
                    <th>Total</th>
                    <th>Alive</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="teamsBody"></tbody>
        </table>
    </div>

    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

        // Supabase client
        const SUPABASE_URL = "https://mwijanqtgnldcvvgmaft.supabase.co";
        const SUPABASE_ANON_KEY =
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im13aWphbnF0Z25sZGN2dmdtYWZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5MzAzNTYsImV4cCI6MjA3OTUwNjM1Nn0.IrK7jc6EvcfBZhfxnvQrspPquN6Pbz_7P-DRdYWnRKM";

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // DOM
        const loginCard = document.getElementById("loginCard");
        const adminCard = document.getElementById("adminCard");
        const loginForm = document.getElementById("loginForm");
        const loginError = document.getElementById("loginError");
        const emailInput = document.getElementById("email");
        const passInput = document.getElementById("password");
        const userEmail = document.getElementById("userEmail");

        const logoutBtn = document.getElementById("logoutBtn");
        const nextMatchBtn = document.getElementById("nextMatchBtn");
        const hardResetBtn = document.getElementById("hardResetBtn");
        const matchNumberDisplay = document.getElementById("matchNumberDisplay");
        const matchNameDisplay = document.getElementById("matchNameDisplay");
        const matchNameInput = document.getElementById("matchNameInput");
        const saveMatchNameBtn = document.getElementById("saveMatchNameBtn");

        const teamForm = document.getElementById("teamForm");
        const teamName = document.getElementById("teamName");
        const teamSlot = document.getElementById("teamSlot");
        const teamLogo = document.getElementById("teamLogo");
        const editingId = document.getElementById("editingId");
        const teamMsg = document.getElementById("teamMsg");
        const teamsBody = document.getElementById("teamsBody");

        // Match meta (local only)
        let matchNumber = Number(localStorage.getItem("matchNumber") || "1");
        let matchName = localStorage.getItem("matchName") || "";

        function updateMatchUI() {
            matchNumberDisplay.textContent = matchNumber;
            matchNameDisplay.textContent = matchName ? `(${matchName})` : "";
            matchNameInput.value = matchName;
        }

        updateMatchUI();

        saveMatchNameBtn.addEventListener("click", () => {
            matchName = matchNameInput.value.trim();
            localStorage.setItem("matchName", matchName);
            updateMatchUI();
            teamMsg.textContent = "Match name saved.";
            setTimeout(() => { teamMsg.textContent = ""; }, 2000);
        });

        // Auth UI
        async function refreshAuthUI() {
            const { data } = await supabase.auth.getUser();
            if (data.user) {
                loginCard.classList.add("hidden");
                adminCard.classList.remove("hidden");
                userEmail.textContent = data.user.email || "";
                loadTeams();
                setupRealtime();
            } else {
                adminCard.classList.add("hidden");
                loginCard.classList.remove("hidden");
                userEmail.textContent = "";
                teamsBody.innerHTML = "";
            }
        }

        loginForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            loginError.textContent = "";
            const email = emailInput.value.trim();
            const password = passInput.value.trim();

            const { error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) {
                console.error(error);
                loginError.textContent = error.message;
                return;
            }
            loginForm.reset();
            refreshAuthUI();
        });

        logoutBtn.addEventListener("click", async () => {
            await supabase.auth.signOut();
            refreshAuthUI();
        });

        // Load & render teams (SLOT ORDER)
        async function loadTeams() {
            const { data, error } = await supabase
                .from("teams")
                .select("*")
                .order("slot", { ascending: true });  // <<< SORT BY SLOT ONLY

            if (error) {
                console.error(error);
                return;
            }
            renderTeams(data || []);
        }

        function renderAliveBars(countRaw) {
            const count = Math.max(0, Math.min(4, typeof countRaw === "number" ? countRaw : 4));
            let bars = "";
            for (let i = 0; i < 4; i++) {
                const cls = i < count ? "alive" : "dead";
                bars += `<div class="alive-bar ${cls}"></div>`;
            }
            return { html: bars, count };
        }

        function renderTeams(list) {
            teamsBody.innerHTML = "";

            list.forEach((t) => {
                const tr = document.createElement("tr");

                const { html: aliveBarsHtml, count: aliveCount } = renderAliveBars(t.alive);

                const slotCell = `<td>${t.slot ?? ""}</td>`;
                const logoCell = `<td>${t.logo ? `<img src="${t.logo}" class="logo" />` : "-"}</td>`;
                const nameCell = `<td>${t.name ?? ""}</td>`;
                const killsCell = `<td class="kills-cell"></td>`;
                const totalCell = `<td>${t.total ?? 0}</td>`;
                const aliveCell = `
          <td class="alive-cell">
            <div class="alive-cell-table">
              <input class="alive-input" type="number" min="0" max="4" value="${aliveCount}" />
              <div class="alive-bars">${aliveBarsHtml}</div>
            </div>
          </td>`;
                const actionsCell = `<td class="actions"></td>`;

                tr.innerHTML =
                    slotCell + logoCell + nameCell + killsCell + totalCell + aliveCell + actionsCell;

                // Kills input (number up/down)
                const killsTd = tr.querySelector(".kills-cell");
                const killsInput = document.createElement("input");
                killsInput.type = "number";
                killsInput.min = "0";
                killsInput.value = t.score ?? 0;
                killsInput.className = "kills-input";

                killsInput.addEventListener("change", async () => {
                    let val = Number(killsInput.value);
                    if (isNaN(val) || val < 0) val = 0; // no negatives
                    killsInput.value = val;
                    await supabase
                        .from("teams")
                        .update({ score: val })
                        .eq("id", t.id);
                });

                killsTd.appendChild(killsInput);

                // Alive input + bars
                const aliveCellEl = tr.querySelector(".alive-cell");
                const aliveInput = aliveCellEl.querySelector(".alive-input");
                const barsContainer = aliveCellEl.querySelector(".alive-bars");

                function updateAliveBarsUI(newVal) {
                    const n = Math.max(0, Math.min(4, newVal));
                    barsContainer.innerHTML = "";
                    for (let i = 0; i < 4; i++) {
                        const bar = document.createElement("div");
                        bar.className = "alive-bar " + (i < n ? "alive" : "dead");
                        barsContainer.appendChild(bar);
                    }
                }

                aliveInput.addEventListener("change", async () => {
                    let val = Number(aliveInput.value);
                    if (isNaN(val)) val = 4;
                    val = Math.max(0, Math.min(4, val));
                    aliveInput.value = val;
                    updateAliveBarsUI(val);
                    await supabase
                        .from("teams")
                        .update({ alive: val })
                        .eq("id", t.id);
                });

                // Actions: Edit + Delete
                const actionsTd = tr.querySelector(".actions");

                const editBtn = document.createElement("button");
                editBtn.textContent = "Edit";
                editBtn.onclick = () => {
                    teamName.value = t.name ?? "";
                    teamSlot.value = t.slot ?? 0;
                    editingId.value = t.id;
                    teamLogo.value = "";
                    teamMsg.textContent = `Editing team: ${t.name}`;
                    window.scrollTo({ top: 0, behavior: "smooth" });
                };

                const delBtn = document.createElement("button");
                delBtn.textContent = "Del";
                delBtn.style.background = "#f97316";
                delBtn.onclick = async () => {
                    if (confirm(`Delete team "${t.name}"?`)) {
                        await supabase.from("teams").delete().eq("id", t.id);
                    }
                };

                actionsTd.appendChild(editBtn);
                actionsTd.appendChild(delBtn);

                teamsBody.appendChild(tr);
            });
        }

        // Realtime
        let realtimeChannel = null;
        function setupRealtime() {
            if (realtimeChannel) return;
            realtimeChannel = supabase
                .channel("teams-changes-admin")
                .on(
                    "postgres_changes",
                    { event: "*", schema: "public", table: "teams" },
                    () => loadTeams()
                )
                .subscribe();
        }

        // Add / Update team from form
        teamForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            teamMsg.textContent = "Saving...";
            const name = teamName.value.trim();
            const slot = Number(teamSlot.value) || 0;
            const id = editingId.value;
            const file = teamLogo.files[0];

            let logoUrl = null;

            try {
                if (file) {
                    const filePath = `team-logos/${Date.now()}_${file.name}`;
                    const { error: uploadError } = await supabase
                        .storage
                        .from("logos")
                        .upload(filePath, file);

                    if (uploadError) throw uploadError;

                    const { data: urlData } = supabase
                        .storage
                        .from("logos")
                        .getPublicUrl(filePath);

                    logoUrl = urlData.publicUrl;
                }

                if (id) {
                    const updateData = { name, slot };
                    if (logoUrl) updateData.logo = logoUrl;

                    const { error } = await supabase
                        .from("teams")
                        .update(updateData)
                        .eq("id", id);
                    if (error) throw error;

                    teamMsg.textContent = "Team updated.";
                } else {
                    const insertData = {
                        name,
                        slot,
                        logo: logoUrl,
                        score: 0,   // kills default 0
                        total: 0,   // total default 0
                        alive: 4    // all alive
                    };
                    const { error } = await supabase
                        .from("teams")
                        .insert([insertData]);
                    if (error) throw error;

                    teamMsg.textContent = "Team added.";
                }

                teamForm.reset();
                editingId.value = "";
            } catch (err) {
                console.error(err);
                teamMsg.textContent = "Error: " + err.message;
            }
        });

        // Next Match: download CSV, add kills to total, reset round
        nextMatchBtn.addEventListener("click", async () => {
            if (!confirm("Next match?\nThis will download current data, add kills to total, and reset kills & alive.")) {
                return;
            }
            teamMsg.textContent = "Processing next match...";

            // Fetch current data (slot order for CSV)
            const { data, error } = await supabase
                .from("teams")
                .select("*")
                .order("slot", { ascending: true });

            if (error) {
                console.error(error);
                teamMsg.textContent = "Error fetching data: " + error.message;
                return;
            }

            const teams = data || [];
            if (teams.length === 0) {
                teamMsg.textContent = "No teams to process.";
                return;
            }

            // CSV
            const header = ["match_number", "match_name", "slot", "name", "score", "total", "alive", "id", "created_at"];
            const rows = [header.join(",")];
            for (const t of teams) {
                const row = [
                    matchNumber,
                    `"${(matchName || "").replace(/"/g, '""')}"`,
                    t.slot ?? "",
                    `"${(t.name || "").replace(/"/g, '""')}"`,
                    t.score ?? 0,
                    t.total ?? 0,
                    typeof t.alive === "number" ? t.alive : "",
                    t.id,
                    t.created_at || ""
                ];
                rows.push(row.join(","));
            }
            const csvContent = rows.join("\n");
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const safeName = (matchName || "match").replace(/[^a-z0-9_-]+/gi, "_");
            const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
            const a = document.createElement("a");
            a.href = url;
            a.download = `glacier_${safeName}_M${matchNumber}_${timestamp}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            // Update totals and reset round
            try {
                for (const t of teams) {
                    const currentScore = Math.max(0, t.score ?? 0);
                    const currentTotal = Math.max(0, t.total ?? 0);
                    const newTotal = currentTotal + currentScore;
                    const { error: updError } = await supabase
                        .from("teams")
                        .update({
                            total: newTotal,
                            score: 0,  // reset kills
                            alive: 4   // reset alive
                        })
                        .eq("id", t.id);
                    if (updError) {
                        console.error("Update error for id", t.id, updError);
                    }
                }

                // bump match number
                matchNumber += 1;
                localStorage.setItem("matchNumber", String(matchNumber));
                updateMatchUI();

                teamMsg.textContent = "Next match done: data downloaded, totals updated, round reset.";
            } catch (err) {
                console.error(err);
                teamMsg.textContent = "Error during next match update: " + err.message;
            }
        });

        // Hard Reset: set kills=0, total=0, alive=4, reset match number & name
        hardResetBtn.addEventListener("click", async () => {
            if (!confirm("HARD RESET?\nThis will set kills & totals to 0 and alive to 4 for ALL teams, and reset match number & name.")) {
                return;
            }
            teamMsg.textContent = "Hard reset in progress...";

            const { data, error } = await supabase
                .from("teams")
                .select("*");

            if (error) {
                console.error(error);
                teamMsg.textContent = "Error fetching teams: " + error.message;
                return;
            }

            const teams = data || [];

            try {
                for (const t of teams) {
                    const { error: updError } = await supabase
                        .from("teams")
                        .update({
                            score: 0,
                            total: 0,
                            alive: 4
                        })
                        .eq("id", t.id);
                    if (updError) {
                        console.error("Hard reset update error for id", t.id, updError);
                    }
                }

                // reset match meta
                matchNumber = 1;
                matchName = "";
                localStorage.setItem("matchNumber", "1");
                localStorage.setItem("matchName", "");
                updateMatchUI();

                teamMsg.textContent = "Hard reset completed.";
            } catch (err) {
                console.error(err);
                teamMsg.textContent = "Error during hard reset: " + err.message;
            }
        });

        // Start
        refreshAuthUI();
    </script>
</body>

</html>