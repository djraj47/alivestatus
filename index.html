<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Scoreboard Admin</title>

    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Teko", sans-serif;
        }

        body {
            background: #000000;
            color: #ffffff;
            display: flex;
            justify-content: center;
            padding: 8px;
        }

        .admin-wrapper {
            width: 820px;
            /* a bit smaller overall */
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .match-info {
            font-size: 26px;
        }

        .match-info span {
            font-weight: 700;
        }

        .controls {
            display: flex;
            gap: 6px;
        }

        button {
            border: none;
            cursor: pointer;
            padding: 3px 10px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 3px;
            text-transform: uppercase;
            background: #222222;
            color: #ffffff;
        }

        button:hover {
            background: #333333;
        }

        .panel {
            background: #050505;
            border-radius: 4px;
            padding: 6px;
            border: 1px solid #333333;
        }

        .tables-grid {
            display: flex;
            gap: 6px;
            justify-content: space-between;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 16px;
        }

        .teams-table {
            width: 50%;
        }

        thead {
            background: #111111;
        }

        th,
        td {
            border-bottom: 1px solid #222222;
            padding: 2px 3px;
            text-align: center;
        }

        th {
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }

        tbody tr:nth-child(even) {
            background: #050505;
        }

        tbody tr:nth-child(odd) {
            background: #0a0a0a;
        }

        .idx {
            width: 24px;
            font-size: 15px;
        }

        .logo-cell {
            width: 46px;
        }

        .logo-preview {
            width: 30px;
            height: 30px;
            border-radius: 3px;
            background: #111111;
            object-fit: cover;
            display: block;
            margin: 0 auto 1px;
        }

        .logo-input {
            width: 100%;
            font-size: 11px;
        }

        .team-input {
            width: 70px;
            font-size: 18px;
            text-align: left;
            padding-left: 3px;
            background: #050505;
            border: 1px solid #333333;
            color: #ffffff;
        }

        .alive-select {
            width: 48px;
            font-size: 18px;
            background: #050505;
            border: 1px solid #333333;
            color: #ffffff;
        }

        .num-input {
            width: 52px;
            font-size: 18px;
            text-align: center;
            background: #050505;
            border: 1px solid #333333;
            color: #ffffff;
        }

        .readonly {
            color: #cccccc;
            font-size: 18px;
        }

        tfoot td {
            border-top: 1px solid #222222;
            padding-top: 4px;
            font-size: 12px;
            color: #aaaaaa;
        }
    </style>
</head>

<body>

    <div class="admin-wrapper">

        <div class="top-bar">
            <div class="match-info">
                MATCH: <span id="match-number">1</span>
            </div>
            <div class="controls">
                <button id="btn-next-match">Next Match</button>
                <button id="btn-hard-reset">Hard Reset</button>
            </div>
        </div>

        <div class="panel">
            <div class="tables-grid">
                <!-- LEFT 10 TEAMS -->
                <table class="teams-table">
                    <thead>
                        <tr>
                            <th class="idx">#</th>
                            <th class="logo-cell">Logo</th>
                            <th>Team</th>
                            <th>Alv</th>
                            <th>Total</th>
                            <th>Match</th>
                            <th>Sum</th>
                        </tr>
                    </thead>
                    <tbody id="teams-left">
                    </tbody>
                </table>

                <!-- RIGHT 10 TEAMS -->
                <table class="teams-table">
                    <thead>
                        <tr>
                            <th class="idx">#</th>
                            <th class="logo-cell">Logo</th>
                            <th>Team</th>
                            <th>Alv</th>
                            <th>Total</th>
                            <th>Match</th>
                            <th>Sum</th>
                        </tr>
                    </thead>
                    <tbody id="teams-right">
                    </tbody>
                </table>
            </div>

            <table>
                <tfoot>
                    <tr>
                        <td colspan="7">
                            All changes auto-save instantly. Overlay updates live from this page via
                            <code>BroadcastChannel("scoreboardChannel")</code>.
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>

    </div>

    <script>
        const DEFAULT_TEAMS = [
            "OG", "MDL", "VLT", "REV", "HUN",
            "K9", "RTX", "ACE", "TX", "XG",
            "GTX", "STN", "BTR", "DFN", "SOX",
            "AXL", "ICE", "FLX", "WAR", "NXT"
        ];

        const leftBody = document.getElementById("teams-left");
        const rightBody = document.getElementById("teams-right");
        const matchEl = document.getElementById("match-number");
        const btnNext = document.getElementById("btn-next-match");
        const btnReset = document.getElementById("btn-hard-reset");

        // ====== LIVE CHANNEL TO OVERLAY ======
        const channel = new BroadcastChannel("scoreboardChannel");

        function broadcastScoreboard() {
            // Send current data to overlay
            channel.postMessage(data);
        }

        function loadData() {
            let stored = JSON.parse(localStorage.getItem("scoreboardData") || "null");
            if (!stored || !Array.isArray(stored) || stored.length === 0) {
                stored = DEFAULT_TEAMS.map(name => ({
                    team: name,
                    alive: 4,
                    total: 0,
                    match: 0,
                    logo: ""
                }));
            }
            return stored;
        }

        function saveData() {
            localStorage.setItem("scoreboardData", JSON.stringify(data));
            localStorage.setItem("scoreboard_updated_at", Date.now().toString());
            // Also push live update to overlay
            broadcastScoreboard();
        }

        function loadMatchNumber() {
            const m = parseInt(localStorage.getItem("matchNumber") || "1", 10);
            return isNaN(m) ? 1 : m;
        }

        function saveMatchNumber() {
            localStorage.setItem("matchNumber", String(matchNumber));
        }

        let data = loadData();
        let matchNumber = loadMatchNumber();
        matchEl.textContent = matchNumber;

        function renderTable() {
            leftBody.innerHTML = "";
            rightBody.innerHTML = "";

            const mid = Math.ceil(data.length / 2); // 10 + 10 for 20 teams
            const leftTeams = data.slice(0, mid);
            const rightTeams = data.slice(mid);

            leftTeams.forEach((t, idx) => {
                const globalIndex = idx;
                const tr = buildRow(t, globalIndex);
                leftBody.appendChild(tr);
            });

            rightTeams.forEach((t, idx) => {
                const globalIndex = idx + mid;
                const tr = buildRow(t, globalIndex);
                rightBody.appendChild(tr);
            });
        }

        function buildRow(team, index) {
            const tr = document.createElement("tr");

            // index
            const tdIdx = document.createElement("td");
            tdIdx.className = "idx";
            tdIdx.textContent = index + 1;

            // logo
            const tdLogo = document.createElement("td");
            tdLogo.className = "logo-cell";
            const img = document.createElement("img");
            img.className = "logo-preview";
            img.src = team.logo || "";
            const file = document.createElement("input");
            file.type = "file";
            file.accept = "image/*";
            file.className = "logo-input";
            file.addEventListener("change", e => handleLogoChange(e, index, img));
            tdLogo.appendChild(img);
            tdLogo.appendChild(file);

            // team name
            const tdTeam = document.createElement("td");
            const inpTeam = document.createElement("input");
            inpTeam.type = "text";
            inpTeam.value = team.team;
            inpTeam.className = "team-input";
            inpTeam.addEventListener("input", () => {
                data[index].team = inpTeam.value.toUpperCase();
                saveData();
            });
            tdTeam.appendChild(inpTeam);

            // alive
            const tdAlive = document.createElement("td");
            const selAlive = document.createElement("select");
            selAlive.className = "alive-select";
            for (let i = 0; i <= 4; i++) {
                const opt = document.createElement("option");
                opt.value = i;
                opt.textContent = i;
                if (i === team.alive) opt.selected = true;
                selAlive.appendChild(opt);
            }
            selAlive.addEventListener("change", () => {
                data[index].alive = parseInt(selAlive.value, 10);
                saveData();
            });
            tdAlive.appendChild(selAlive);

            // total pts
            const tdTotal = document.createElement("td");
            const inpTotal = document.createElement("input");
            inpTotal.type = "number";
            inpTotal.className = "num-input";
            inpTotal.value = team.total;
            inpTotal.addEventListener("input", () => {
                data[index].total = parseInt(inpTotal.value || "0", 10);
                updateRowSum(index);
                saveData();
            });
            tdTotal.appendChild(inpTotal);

            // match pts
            const tdMatch = document.createElement("td");
            const inpMatch = document.createElement("input");
            inpMatch.type = "number";
            inpMatch.className = "num-input";
            inpMatch.value = team.match;
            inpMatch.addEventListener("input", () => {
                data[index].match = parseInt(inpMatch.value || "0", 10);
                updateRowSum(index);
                saveData();
            });
            tdMatch.appendChild(inpMatch);

            // sum
            const tdSum = document.createElement("td");
            const spanSum = document.createElement("span");
            spanSum.className = "readonly";
            spanSum.id = `sum-${index}`;
            spanSum.textContent = (team.total + team.match).toString();
            tdSum.appendChild(spanSum);

            tr.append(tdIdx, tdLogo, tdTeam, tdAlive, tdTotal, tdMatch, tdSum);
            return tr;
        }

        function updateRowSum(index) {
            const span = document.getElementById(`sum-${index}`);
            if (span) {
                span.textContent = (data[index].total + data[index].match).toString();
            }
        }

        function handleLogoChange(e, index, imgEl) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                data[index].logo = ev.target.result;
                imgEl.src = ev.target.result;
                saveData();
            };
            reader.readAsDataURL(file);
        }

        /* Buttons */

        btnReset.addEventListener("click", () => {
            if (!confirm("Hard reset: set all totals & match points to 0 and alive to 4?")) return;
            data = data.map(t => ({
                ...t,
                alive: 4,
                total: 0,
                match: 0
            }));
            matchNumber = 1;
            matchEl.textContent = matchNumber;
            renderTable();
            saveData();
            saveMatchNumber();
        });

        btnNext.addEventListener("click", () => {
            if (!confirm("Next match: add current match points to total, reset match to 0 and alive to 4?")) return;
            data = data.map(t => ({
                ...t,
                total: t.total + t.match,
                match: 0,
                alive: 4
            }));
            matchNumber += 1;
            matchEl.textContent = matchNumber;
            renderTable();
            saveData();
            saveMatchNumber();
        });

        /* initial render */
        renderTable();
        // Also send initial state to overlay when admin opens
        broadcastScoreboard();
    </script>
</body>

</html>