<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Scoreboard Admin</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #020617;
            color: #e5e7eb;
        }

        h2,
        h3 {
            margin-top: 0;
        }

        label {
            font-size: 13px;
            color: #cbd5f5;
        }

        input,
        button {
            margin: 4px 0;
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid #4b5563;
            background: #020617;
            color: #e5e7eb;
        }

        input[type="file"] {
            border: none;
            padding: 0;
        }

        button {
            border: none;
            cursor: pointer;
            background: #3b82f6;
        }

        button.secondary {
            background: #6b7280;
            margin-left: 4px;
        }

        hr {
            border-color: #1f2937;
            margin: 16px 0;
        }

        .card {
            margin: 10px 0;
            padding: 10px;
            border-radius: 6px;
            background: #0b1120;
            border: 1px solid #1f2937;
        }

        .card img {
            border-radius: 4px;
            margin-top: 4px;
        }

        .status {
            font-size: 12px;
            color: #9ca3af;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <h2>Scoreboard Admin</h2>
    <p class="status" id="status">Connectingâ€¦</p>

    <!-- FORM -->
    <div>
        <label>Team Logo:</label><br />
        <input type="file" id="logoFile" accept="image/*" /><br><br>

        <input type="number" id="slot" placeholder="Slot No" /><br>
        <input type="text" id="team" placeholder="Team Name" /><br>
        <input type="number" id="alive" placeholder="Alive" /><br>
        <input type="number" id="total" placeholder="Total Points" /><br>
        <input type="number" id="match" placeholder="Matches" /><br>
        <input type="number" id="position" placeholder="Position / Rank" /><br>

        <button onclick="saveData()" id="saveBtn">Save</button>
        <button class="secondary" onclick="resetForm()">Clear</button>
    </div>

    <hr>

    <h3>Teams</h3>
    <div id="list"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // -------- Supabase client --------
        const db = window.supabase.createClient(
            "https://csabudilbmjvyhilbekw.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzYWJ1ZGlsYm1qdnloaWxiZWt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0OTE1MzYsImV4cCI6MjA3OTA2NzUzNn0.xUygMCObsAMNZ4OHnG4WHmqpmXnF2O-72iCKKMh---o"
        );

        const statusEl = document.getElementById("status");
        let editingId = null; // uuid of row being edited

        // ---------- Upload logo to Storage ----------
        async function uploadLogo(file) {
            if (!file) return null;

            const path = Date.now() + "-" + file.name;

            const { error } = await db.storage.from("logos").upload(path, file);
            if (error) {
                console.error("Storage upload error:", error);
                alert("Logo upload failed: " + error.message);
                return null;
            }

            const { data } = db.storage.from("logos").getPublicUrl(path);
            return data.publicUrl;
        }

        // ---------- Save / Update row ----------
        async function saveData() {
            const slotVal = document.getElementById("slot").value;
            const teamVal = document.getElementById("team").value;

            if (!slotVal || !teamVal) {
                alert("Slot and Team Name are required.");
                return;
            }

            const file = document.getElementById("logoFile").files[0];
            let logoUrl = null;

            if (file) {
                logoUrl = await uploadLogo(file);
                if (!logoUrl) return; // upload failed
            }

            const row = {
                slot: Number(slotVal),
                team: teamVal,
                alive: Number(document.getElementById("alive").value || 0),
                total: Number(document.getElementById("total").value || 0),
                match: Number(document.getElementById("match").value || 0),
                position: Number(document.getElementById("position").value || 0),
            };

            if (logoUrl) row.logo = logoUrl;

            let response;
            if (editingId) {
                // UPDATE by uuid id
                response = await db
                    .from("scoreboard_teams")
                    .update(row)
                    .eq("id", editingId);
            } else {
                // INSERT new row (id auto uuid)
                response = await db.from("scoreboard_teams").insert(row);
            }

            if (response.error) {
                console.error("DB ERROR (insert/update):", response.error);
                alert("DB error: " + response.error.message);
                return;
            }

            editingId = null;
            resetForm();
            await loadData();
        }

        function resetForm() {
            editingId = null;
            document.getElementById("slot").value = "";
            document.getElementById("team").value = "";
            document.getElementById("alive").value = "";
            document.getElementById("total").value = "";
            document.getElementById("match").value = "";
            document.getElementById("position").value = "";
            document.getElementById("logoFile").value = "";
            document.getElementById("saveBtn").textContent = "Save";
        }

        // ---------- Load all rows ----------
        async function loadData() {
            const { data, error } = await db
                .from("scoreboard_teams")
                .select("*")
                .order("position", { ascending: true });

            if (error) {
                console.error("Load error:", error);
                statusEl.textContent = "Error loading data: " + error.message;
                return;
            }

            statusEl.textContent = "Connected. Realtime enabled.";
            const list = document.getElementById("list");
            list.innerHTML = "";

            data.forEach(row => {
                list.innerHTML += `
          <div class="card">
            <div><strong>${row.position}. ${row.team}</strong> (Slot ${row.slot})</div>
            ${row.logo ? `<img src="${row.logo}" width="70" alt="logo">` : ""}
            <div>Alive: ${row.alive} | Total: ${row.total} | Match: ${row.match}</div>
            <div style="margin-top:6px;">
              <button onclick="editRow('${row.id}')">Edit</button>
              <button class="secondary" onclick="removeRow('${row.id}')">Delete</button>
            </div>
          </div>
        `;
            });
        }

        // ---------- Edit & Delete ----------
        async function editRow(id) {
            const { data, error } = await db
                .from("scoreboard_teams")
                .select("*")
                .eq("id", id)
                .single();

            if (error) {
                console.error("Edit fetch error:", error);
                alert("Error loading row: " + error.message);
                return;
            }

            editingId = id;
            document.getElementById("slot").value = data.slot ?? "";
            document.getElementById("team").value = data.team ?? "";
            document.getElementById("alive").value = data.alive ?? "";
            document.getElementById("total").value = data.total ?? "";
            document.getElementById("match").value = data.match ?? "";
            document.getElementById("position").value = data.position ?? "";
            document.getElementById("saveBtn").textContent = "Update";
            // logo file can't be pre-filled (browser security)
        }

        async function removeRow(id) {
            const { error } = await db
                .from("scoreboard_teams")
                .delete()
                .eq("id", id);

            if (error) {
                console.error("Delete error:", error);
                alert("Delete failed: " + error.message);
                return;
            }

            await loadData();
        }

        // ---------- Initial load ----------
        loadData();

        // ---------- Realtime subscription ----------
        db.channel("scoreboard_teams_changes")
            .on(
                "postgres_changes",
                { event: "*", schema: "public", table: "scoreboard_teams" },
                () => {
                    loadData();
                }
            )
            .subscribe((status) => {
                if (status === "SUBSCRIBED") {
                    statusEl.textContent = "Connected. Realtime enabled.";
                }
            });
    </script>
</body>

</html>